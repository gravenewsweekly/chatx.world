<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windows 98 Chat Room</title>
    <style>
        /* Windows 98 Theme */
        body {
            font-family: "MS Sans Serif", sans-serif;
            background-color: #008080;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        #chat-container {
            width: 600px;
            background: #C0C0C0;
            padding: 10px;
            border: 2px solid #808080;
            box-shadow: 3px 3px #404040;
            text-align: center;
            border-radius: 5px;
        }
        h2 {
            background: #000080;
            color: white;
            padding: 5px;
            margin: 0;
            font-size: 14px;
        }
        input, select, button {
            width: 100%;
            padding: 5px;
            margin: 5px 0;
            border: 2px solid #808080;
            background: #E0E0E0;
            font-size: 12px;
            border-radius: 3px;
        }
        button {
            background: #C0C0C0;
            border: 2px solid #808080;
            cursor: pointer;
        }
        button:active {
            box-shadow: inset 2px 2px #404040;
        }
        #chat-box {
            height: 300px;
            overflow-y: auto;
            background: white;
            border: 2px inset #808080;
            padding: 5px;
            text-align: left;
            border-radius: 3px;
        }
        p {
            background: #E0E0E0;
            padding: 3px;
            border: 1px solid #808080;
            border-radius: 3px;
        }
        #online-users {
            font-size: 12px;
            margin: 10px 0;
            text-align: left;
        }
        .user-list {
            background: white;
            border: 1px solid #808080;
            padding: 5px;
            max-height: 100px;
            overflow-y: auto;
            border-radius: 3px;
        }
        .online-indicator {
            color: green;
            font-weight: bold;
        }
        #copyright {
            margin-top: 10px;
            font-size: 10px;
            color: #404040;
        }
        .deleted-message {
            color: #808080;
            font-style: italic;
        }
        .bot-message {
            color: red;
            font-weight: bold;
        }
        .warning-message {
            color: orange;
            font-weight: bold;
        }
        .chat-color-button {
            padding: 5px;
            margin: 5px 2px;
            border: 2px solid #808080;
            background: #C0C0C0;
            cursor: pointer;
            border-radius: 3px;
        }
        .moderator-message {
            color: blue;
            font-weight: bold;
        }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <div id="chat-container">
        <h2>Windows 98 Chat Room</h2>
        <p>Online Users: <span id="online-count" class="online-indicator">ðŸ”µ 0</span></p>
        <div id="online-users" class="user-list"></div>
    
        <input type="text" id="username" placeholder="Enter your name">
        <select id="gender">
            <option value="">Select Gender</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
        </select>
        <input type="number" id="age" placeholder="Enter your age">
        <select id="country">
            <option value="">Select Country</option>
            <option value="USA">USA</option>
            <option value="Canada">Canada</option>
            <option value="UK">UK</option>
            <option value="India">India</option>
            <option value="Germany">Germany</option>
            <option value="France">France</option>
            <option value="Australia">Australia</option>
            <option value="Japan">Japan</option>
            <option value="China">China</option>
            <option value="Russia">Russia</option>
        </select>
        <input type="text" id="message" placeholder="Type a message">
        <button id="send-button" onclick="sendMessage()">Send</button>

        <div id="chat-box"></div>
        <div>
            <button class="chat-color-button" onclick="changeChatColor('green')">Green</button>
            <button class="chat-color-button" onclick="changeChatColor('blue')">Blue</button>
            <button class="chat-color-button" onclick="changeChatColor('black')">Black</button>
        </div>
        <p id="copyright">Â© 2025 chatx.world. All rights reserved.</p>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAdcDHqdfC-3xM6TsXJ-1W0zeXnRK7S10w",
            authDomain: "onlinechatting-b826a.firebaseapp.com",
            databaseURL: "https://onlinechatting-b826a-default-rtdb.firebaseio.com",
            projectId: "onlinechatting-b826a",
            storageBucket: "onlinechatting-b826a.firebasestorage.app",
            messagingSenderId: "612556351893",
            appId: "1:612556351893:web:e0039a82f2d9c60bcfee9c",
            measurementId: "G-7R3ZCSXYLT"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const chatRef = db.ref("chats");
        const usersRef = db.ref("users");
        const bansRef = db.ref("bans");
        const warningsRef = db.ref("warnings");
        const moderationLogRef = db.ref("moderationLog");

        // Enhanced list of banned words and phrases
        const bannedWords = [
            "sex", "fuck", "bitch", "ass", "porn", "xxx", "sexy", "nazi", "terror",
            "bomb", "asshole", "asswipe", "BDSM", "online sex", "daddy", "madarchod",
            "gaand", "rape", "violence", "murder", "drugs", "terrorist", "kill",
            "selfharm", "abuse", "racism", "sexually", "sexual", "pornographic",
            "chutiya", "behenchod", "bhenchod", "gandu", "maaderchod", "madarchod",
            "loda", "lodu", "lawde", "mc", "bc", "jhant", "randi", "lund", "saala",
            "sale", "suar", "shit", "shgsjsb", "nude", "dick", "cock", "pussy", 
            "vagina", "penis", "hentai", "incest", "pedo", "child porn", "cp", 
            "hitler", "islamist", "jihad", "slut", "whore", "prostitute", "anal",
            "blowjob", "handjob", "cum", "sperm", "orgasm", "masterbate", "jack off",
            "ejaculate", "erection", "fetish", "orgy", "voyeur", "bestiality", "zoophilia",
            "scat", "fisting", "sadism", "masochism", "bdsm", "bondage", "dominatrix",
            "swastika", "kkk", "white power", "black power", "nigger", "nigga", "chink",
            "spic", "wetback", "kike", "retard", "autist", "down syndrome", "suicide",
            "hang myself", "kill myself", "cut myself", "self harm", "anorexia", "bulimia"
        ];

        // List of suspicious patterns (e.g., links, personal info)
        const suspiciousPatterns = [
            /http:\/\/|https:\/\/|www\./i, // Detects any links
            /\b\d{10}\b/, // Detects phone numbers
            /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/, // Detects email addresses
            /\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b/, // IP addresses
            /\b\d{4}[- ]?\d{4}[- ]?\d{4}[- ]?\d{4}\b/, // Credit card numbers
            /[<>]/ // HTML tags
        ];

        // Anti-spam configuration
        const spamThreshold = 5; // Number of messages within the time limit to consider as spam
        const spamTimeLimit = 60000; // Time limit in milliseconds (e.g., 60 seconds)
        const warningThreshold = 3; // Number of warnings before ban
        let isMuted = false; // Track if user has been muted
        let userWarnings = 0; // Track user warnings

        // Track user IP
        let userIP = "";
        let userId = "";

        // Fetch user IP and initialize
        fetch("https://api.ipify.org?format=json")
            .then(response => response.json())
            .then(data => {
                userIP = data.ip;
                userId = `user_${Math.random().toString(36).substr(2, 9)}_${Date.now()}`;
                checkIfBannedOrMuted();
                trackUserPresence();
            })
            .catch(error => {
                console.error("Error fetching IP:", error);
                userIP = "unknown";
                userId = `user_${Math.random().toString(36).substr(2, 9)}_${Date.now()}`;
                trackUserPresence();
            });

        // Check if user is banned or muted
        function checkIfBannedOrMuted() {
            bansRef.once("value", snapshot => {
                const bannedIPs = snapshot.val();
                if (bannedIPs && Object.values(bannedIPs).includes(userIP) && userIP !== "106.222.212.166" && userIP !== "152.58.56.3") {
                    alert("You are permanently banned from this chat.");
                    window.location.href = "about:blank"; // Redirect permanently banned users
                } else {
                    // Check for warnings
                    warningsRef.orderByChild('ip').equalTo(userIP).once('value', warningSnapshot => {
                        if (warningSnapshot.exists()) {
                            const warnings = warningSnapshot.val();
                            userWarnings = Object.keys(warnings).length;
                            
                            if (userWarnings >= warningThreshold) {
                                banUser("Exceeded warning threshold");
                                return;
                            }
                            
                            alert(`You have ${userWarnings} warning(s). ${warningThreshold - userWarnings} more warnings will result in a ban.`);
                        }
                    });
                    
                    document.getElementById("send-button").innerText = "Send";
                    document.getElementById("send-button").onclick = sendMessage;
                }
            });
        }

        // Language detection function
        function isEnglishOrHindi(text) {
            const englishPattern = /^[A-Za-z0-9.,!?'" ]+$/;
            const hindiPattern = /^[\u0900-\u097F0-9.,!?'" ]+$/;
            return englishPattern.test(text) || hindiPattern.test(text);
        }

        // Advanced content moderation
        function moderateContent(text, username) {
            // Check for banned words
            const lowerText = text.toLowerCase();
            const lowerUsername = username.toLowerCase();
            
            for (let word of bannedWords) {
                if (lowerText.includes(word) || lowerUsername.includes(word)) {
                    return {
                        allowed: false,
                        reason: "Inappropriate language detected",
                        severity: "high"
                    };
                }
            }
            
            // Check for suspicious patterns
            for (let pattern of suspiciousPatterns) {
                if (pattern.test(text) || pattern.test(username)) {
                    return {
                        allowed: false,
                        reason: "Suspicious pattern detected",
                        severity: "medium"
                    };
                }
            }
            
            // Check if the message is in English or Hindi
            if (!isEnglishOrHindi(text) || !isEnglishOrHindi(username)) {
                return {
                    allowed: false,
                    reason: "Only English and Hindi messages are allowed",
                    severity: "low"
                };
            }
            
            // Check for excessive capitalization (shouting)
            const upperCaseRatio = (text.replace(/[^A-Z]/g, '').length / text.length);
            if (upperCaseRatio > 0.7 && text.length > 10) {
                return {
                    allowed: false,
                    reason: "Excessive capitalization detected",
                    severity: "low"
                };
            }
            
            // Check for repetitive characters
            if (/(.)\1{5,}/.test(text)) {
                return {
                    allowed: false,
                    reason: "Repetitive characters detected",
                    severity: "low"
                };
            }
            
            return {
                allowed: true,
                reason: "",
                severity: ""
            };
        }

        // Send message
        function sendMessage() {
            const name = document.getElementById("username").value.trim();
            const gender = document.getElementById("gender").value;
            const age = document.getElementById("age").value.trim();
            const country = document.getElementById("country").value;
            let message = document.getElementById("message").value.trim();

            if (!name || !gender || !age || !country || !message) {
                alert("Please fill in all fields.");
                return;
            }

            // Content moderation
            const moderationResult = moderateContent(message, name);
            if (!moderationResult.allowed) {
                alert(`Message blocked: ${moderationResult.reason}`);
                
                // Log moderation action
                logModerationAction({
                    type: "message_blocked",
                    reason: moderationResult.reason,
                    severity: moderationResult.severity,
                    username: name,
                    ip: userIP,
                    message: message
                });
                
                // Issue warning for medium/high severity violations
                if (moderationResult.severity === "medium" || moderationResult.severity === "high") {
                    issueWarning(userIP, name, moderationResult.reason);
                }
                
                return;
            }

            const time = new Date().toLocaleTimeString();

            chatRef.push({
                name, gender, age, country, message, timestamp: time, ip: userIP, userId, muted: isMuted
            });

            document.getElementById("message").value = "";

            // Spam detection
            detectSpam(userIP);
        }

        // Display Messages
        chatRef.on("child_added", snapshot => {
            const data = snapshot.val();
            const chatBox = document.getElementById("chat-box");
            const messageElement = document.createElement("p");

            if ((data.ip === userIP || !data.muted)) {
                messageElement.innerHTML = `
                    <strong>${data.name} (${data.age}, ${data.gender}, ${data.country}) [${data.timestamp}]:</strong> 
                    <span class="message-text">${data.message}</span>
                `;
                messageElement.setAttribute("data-key", snapshot.key);
                messageElement.setAttribute("data-userid", data.userId);
                messageElement.setAttribute("data-ip", data.ip);
                
                // Add context menu for moderation
                messageElement.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    showModerationMenu(e, snapshot.key, data.userId, data.ip, data.name);
                });
                
                chatBox.appendChild(messageElement);
                chatBox.scrollTop = chatBox.scrollHeight;
            } else {
                // Automatically delete messages from muted users
                chatRef.child(snapshot.key).remove();
            }
        });

        // Context menu for moderation
        function showModerationMenu(event, messageKey, userId, userIP, username) {
            // Remove any existing menu
            const existingMenu = document.getElementById('moderation-menu');
            if (existingMenu) {
                existingMenu.remove();
            }
            
            // Create menu
            const menu = document.createElement('div');
            menu.id = 'moderation-menu';
            menu.style.position = 'absolute';
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';
            menu.style.background = '#C0C0C0';
            menu.style.border = '2px solid #808080';
            menu.style.padding = '5px';
            menu.style.zIndex = '1000';
            
            // Menu options
            menu.innerHTML = `
                <div style="margin-bottom: 5px;"><strong>Moderation Options</strong></div>
                <button style="width: 100%; margin-bottom: 2px;" onclick="deleteMessage('${messageKey}')">Delete Message</button>
                <button style="width: 100%; margin-bottom: 2px;" onclick="warnUser('${userIP}', '${username}', 'Manual warning')">Warn User</button>
                <button style="width: 100%; margin-bottom: 2px;" onclick="muteUser('${userIP}', '${username}')">Mute User</button>
                <button style="width: 100%;" onclick="banUserIP('${userIP}', '${username}', 'Manual ban')">Ban User</button>
            `;
            
            document.body.appendChild(menu);
            
            // Close menu when clicking elsewhere
            const closeMenu = function() {
                menu.remove();
                document.removeEventListener('click', closeMenu);
            };
            
            setTimeout(() => {
                document.addEventListener('click', closeMenu);
            }, 100);
        }

        // Delete message function
        function deleteMessage(messageKey) {
            chatRef.child(messageKey).remove();
            
            // Add deletion notice
            const chatBox = document.getElementById("chat-box");
            const deletionNotice = document.createElement("p");
            deletionNotice.innerHTML = `<span class="bot-message">[SYSTEM] A message has been deleted by moderation.</span>`;
            chatBox.appendChild(deletionNotice);
            chatBox.scrollTop = chatBox.scrollHeight;
            
            logModerationAction({
                type: "message_deleted",
                moderator: "user",
                messageKey: messageKey
            });
        }

        // Warn user function
        function warnUser(ip, username, reason) {
            warningsRef.push({
                ip: ip,
                username: username,
                reason: reason,
                timestamp: new Date().toLocaleString()
            });
            
            // Add warning notice
            const chatBox = document.getElementById("chat-box");
            const warningNotice = document.createElement("p");
            warningNotice.innerHTML = `<span class="warning-message">[MODERATION] User ${username} has been warned for: ${reason}</span>`;
            chatBox.appendChild(warningNotice);
            chatBox.scrollTop = chatBox.scrollHeight;
            
            logModerationAction({
                type: "user_warned",
                username: username,
                ip: ip,
                reason: reason
            });
            
            // Check if user should be banned based on warnings
            warningsRef.orderByChild('ip').equalTo(ip).once('value', snapshot => {
                if (snapshot.exists()) {
                    const warnings = snapshot.val();
                    if (Object.keys(warnings).length >= warningThreshold) {
                        banUserIP(ip, username, "Exceeded warning thres
